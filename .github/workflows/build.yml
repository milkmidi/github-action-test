# https://docs.github.com/en/actions/learn-github-actions/contexts#github-context
name: Build and Deploy
on:
  push:
    branches:
      - main
      - sandbox
      - dev
  repository_dispatch:
    types: [external-trigger]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GITHUB_ACTION_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
  SLACK_HOOK_URL: ${{ secrets.SLACK_HOOK_URL }}
jobs:
  test: 
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
      - run: npm install
      - run: npm test
  node-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      - name: node-build
        env:
          MOCK_KEY: ${{ secrets.MOCK_KEY }}
        run: |
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          npm install
          node ./internals/index.js
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      - name: get payload data
        run: |
          echo "BRANCH=${{ github.event.client_payload.branch }}" >> $GITHUB_ENV
          echo "${{ github.event.client_payload.branch }}"
        # ------------------------------------------------------------------
      - name: Set current date as env variable
        run: echo "NOW=$(date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_ENV
        # ------------------------------------------------------------------
      - name: npm install, test and build
        env:
          MOCK_KEY: ${{ secrets.MOCK_KEY }}
        run: |
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "${{ env.GITHUB_ACTION_URL }}"
          echo "${{ env.NOW }}"
          npm install
          npm run build
        # ------------------------------------------------------------------
        # ███████╗██╗   ██╗ ██████╗ ██████╗███████╗███████╗███████╗
        # ██╔════╝██║   ██║██╔════╝██╔════╝██╔════╝██╔════╝██╔════╝
        # ███████╗██║   ██║██║     ██║     █████╗  ███████╗███████╗
        # ╚════██║██║   ██║██║     ██║     ██╔══╝  ╚════██║╚════██║
        # ███████║╚██████╔╝╚██████╗╚██████╗███████╗███████║███████║
        # ╚══════╝ ╚═════╝  ╚═════╝ ╚═════╝╚══════╝╚══════╝╚══════╝
      - name: Send notification to Slack
        if: ${{ success() }}
        run: |
          curl --location --request POST '${{ env.SLACK_HOOK_URL }}' --header 'Content-Type:application/json' --data-raw '{"attachments": [{"color": "#00994D","blocks": [{"type": "section","text": {"type": "mrkdwn","text": ":white_check_mark: ${{ env.NOW }} ${{ env.BUILD_ENV }} deploy succeed! ${{ env.GITHUB_ACTION_URL }}"}}]}]}'
        # ███████╗ █████╗ ██╗██╗     
        # ██╔════╝██╔══██╗██║██║     
        # █████╗  ███████║██║██║     
        # ██╔══╝  ██╔══██║██║██║     
        # ██║     ██║  ██║██║███████╗
        # ╚═╝     ╚═╝  ╚═╝╚═╝╚══════╝
      - name: Notify Slack Failure
        if: ${{ failure() }}
        run: |
          curl --location --request POST '${{ env.SLACK_HOOK_URL }}' --header 'Content-Type:application/json' --data-raw '{"attachments": [{"color": "#e02020","blocks": [{"type": "section","text": {"type": "mrkdwn","text": ":x: ${{ env.NOW }} ${{ env.BUILD_ENV }} deploy failed! ${{ env.GITHUB_ACTION_URL }}"}}]}]}'

  slack-notification:
    if: always()
    needs:
      - test
      - build
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ (needs.test.result == 'failure' || needs.build.result == 'failure') }}
          fields: repo,message,commit,author,action,eventName,ref,workflow,pullRequest
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_HOOK_URL }}
